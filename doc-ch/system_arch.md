# 系统架构

BlockEmulator 采用分层的方法进行设计，每一层都负责独立的事务，并且尽可能的让每一层都只与其邻近层发生交互，实现系统层面的功能结构，帮助用户快速熟悉系统并进行代码复用和改造，整个架构可以划分为具体的五个层次，按照层次接近真实数据（交易数据）的远近可以划分为，存储层、数据层、网络层、共识层和使用层。

1. **存储层：** 主要负责数据的持久化存储，在此层会设计仿真区块链存储的数据内容以及相关的存储形式，即包含区块存储、区块链状态树存储、公私钥的存储等等，在本层基于boltDB数据库来实现存储层的功能。 
2. **数据层：** 主要定义系统中数据的具体形式，在此层会描述仿真区块链中各类数据的基本数据结构，包括区块链账户、交易、区块、状态树、节点等，本层的内容会积极的和存储层进行交互，随着仿真区块链的运行，每时每刻的账户信息、交易信息和区块信息等等都会不断的交给存储层进行存储，同时数据层中信息在某些情况下（如从某一时刻重放系统）也会读取来自存储层的内容，实现数据的实例化。同时数据层提供数据操作相关的功能，比如数据的编码解码等。
3. **网络层：** 主要对端到端的包传输进行定义和控制，端到端的包传输方式在本发明系统中包括网络通信方式、广播方式、网络信息编解码方式等等。对于端到端间包传输的控制，主要集中于控制实体（区块链节点）的传输带宽，系统通过控制共识节点在某个时刻消息的发送频率来达成，如每秒能发十条消息降为每秒一条消息，此外，消息的大小也是可以控制的。网络层与数据层的交互包括在网络层中传输各类的交易数据、区块信息等等。
4. **共识层：** 主要对包括片内共识和分片间共识两类协议进行定义和运行，分片内的共识主要保持分片内各个节点的数据一致，而分片间的共识机制主要来维护有跨分片交易行为出现时候，跨分片交易所涉及到的分片所在的数据的一致性。共识层主要在网络层的基础上运行的，因为共识的运行需要节点间不断的发送各类消息通讯交互来实现。
5. **使用层：** 主要负责系统整体的运行，系统运行前，读取本地数据、读入参数设置以及准备运行环境包括区块链节点的构建等等；在系统运行时，保证交易数据按照参数设置注入、保持数据交换的稳定、确保日志以及实验数据的保存等等；系统运行结束后，能够将保存的实验数据绘制相关的图表，比如随时间变化的区块链吞吐量等等。

![img](./fig/system.png)

BlockEmulator 的分层系统架构模块图

